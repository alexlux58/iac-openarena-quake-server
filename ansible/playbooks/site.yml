---
# Main Ansible Playbook for Browser Game Arcade
# This playbook configures a multi-game browser arcade on Amazon Linux 2
# Includes QuakeJS and other browser-based games accessible via HTTP

- name: Configure Browser Game Arcade Server
  hosts: quake  # Host group defined in inventory/hosts.ini
  become: true  # Run tasks with sudo/root privileges
  gather_facts: false  # Disable fact gathering initially to avoid Python version issues

  # Pre-flight: Ensure Python 3.8+ is available for Ansible modules
  # Use raw commands since we can't rely on Python modules yet
  pre_tasks:
    - name: Check if Python 3.8 exists (raw command)
      ansible.builtin.raw: test -f /usr/bin/python3.8 && echo "EXISTS" || echo "NOT_FOUND"
      register: python38_check_raw
      changed_when: false

    - name: Install Python 3.8 if not present (raw command)
      ansible.builtin.raw: |
        if ! command -v python3.8 &> /dev/null; then
          amazon-linux-extras enable python3.8 -y
          yum install -y python38 python38-pip
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1
          echo "INSTALLED"
        else
          echo "ALREADY_INSTALLED"
        fi
      register: python38_install_raw
      changed_when: "'INSTALLED' in python38_install_raw.stdout"

    - name: Verify Python 3.8 installation
      ansible.builtin.raw: python3.8 --version
      register: python_version_raw
      changed_when: false

    - name: Display Python version
      ansible.builtin.debug:
        msg: "Python version: {{ python_version_raw.stdout }}"

    - name: Set Python 3.8 interpreter for remaining tasks
      ansible.builtin.set_fact:
        ansible_python_interpreter: /usr/bin/python3.8

    - name: Gather facts with Python 3.8
      ansible.builtin.setup:

  # Apply roles to install and configure the servers
  roles:
    - web-game
